<?php

namespace App\Mcp\Resources;

use App\Services\SpotifyService;
use Laravel\Mcp\Response;
use Laravel\Mcp\Server\Attributes\Description;
use Laravel\Mcp\Server\Attributes\MimeType;
use Laravel\Mcp\Server\Attributes\Name;
use Laravel\Mcp\Server\Attributes\Uri;
use Laravel\Mcp\Server\Resource;

#[Name('now-playing')]
#[Description('Current Spotify playback state â€” track, artist, album, progress, device')]
#[Uri('spotify://now-playing')]
#[MimeType('application/json')]
class NowPlayingResource extends Resource
{
    public function handle(SpotifyService $spotify): Response
    {
        $playback = $spotify->getCurrentPlayback();

        if (! $playback) {
            return Response::text(json_encode(['playing' => false]));
        }

        return Response::text(json_encode([
            'playing' => $playback['is_playing'],
            'track' => $playback['name'],
            'artist' => $playback['artist'],
            'album' => $playback['album'],
            'progress_ms' => $playback['progress_ms'],
            'duration_ms' => $playback['duration_ms'],
            'shuffle' => $playback['shuffle_state'],
            'repeat' => $playback['repeat_state'],
            'device' => $playback['device']['name'] ?? null,
        ], JSON_UNESCAPED_SLASHES));
    }
}
